<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>wheel</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="images/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script>

        function hexToBytes(hex) {
            let bytes = [];
            for (let c = 0; c < hex.length; c += 2)
                bytes.push(parseInt(hex.substr(c, 2), 16));
            return new Uint8Array(bytes);
        }

        function buf2hex(buffer) { // buffer is an ArrayBuffer
            return [...new Uint8Array(buffer)]
                .map(x => x.toString(16).padStart(2, '0'))
                .join('');
        }

        function sleeper(ms) {
            return function (x) {
                return new Promise(resolve => setTimeout(() => resolve(x), ms));
            };
        }

        class Cphw {
            static CPHW_SERVICE_UUID = '52756265-6e43-6167-6e69-654350485000'
            static CPHW_OTHER_UUID = '52756265-6e43-6167-6e69-654350485001'
            static CPHW_BATTERY_UUID = '52756265-6e43-6167-6e69-65435048500b'
            static CPHW_SERVICE_UUID_100 = '52756265-6e43-6167-6e69-654350485100'
            static AUTH_REQUEST_UUID = '52756265-6e43-6167-6e69-654350485101'
            static AUTH_STATUS_UUID = '52756265-6e43-6167-6e69-654350485104'
            static BOARD_SERIAL_UUID = '52756265-6e43-6167-6e69-654350485105'

            constructor() {
                this.device = null;
                this.onDisconnected = this.onDisconnected.bind(this);
                this.onBatteryChanged = this.onBatteryChanged.bind(this);
                this.serial = '';
                this.eraseData = [];
                this.programBlocks = [];
                this.updateState = 'init';
                this.activeBlock = 0;
            }

            async request() {
                let options = {
                    "filters": [{
                        "services": [Cphw.CPHW_SERVICE_UUID]
                    }],
                    "optionalServices": [Cphw.CPHW_SERVICE_UUID_100]
                };
                return navigator.bluetooth.requestDevice(options)
                    .then(device => {
                        this.device = device;
                        this.device.addEventListener('gattserverdisconnected', this.onDisconnected);
                    });
            }

            async connect() {
                if (!this.device) {
                    return Promise.reject('Device is not connected.');
                }
                console.log('connecting...')
                return this.device.gatt.connect();
            }

            async readSerial() {
                return this.device.gatt.getPrimaryService(Cphw.CPHW_SERVICE_UUID_100)
                    .then(service => service.getCharacteristic(Cphw.BOARD_SERIAL_UUID))
                    .then(characteristic => characteristic.readValue());
            }

            async writePasscode(data) {
                return this.device.gatt.getPrimaryService(Cphw.CPHW_SERVICE_UUID_100)
                    .then(service => service.getCharacteristic(Cphw.AUTH_REQUEST_UUID))
                    .then(characteristic => characteristic.writeValue(data))
            }

            async readAuthStatus() {
                return this.device.gatt.getPrimaryService(Cphw.CPHW_SERVICE_UUID_100)
                    .then(service => service.getCharacteristic(Cphw.AUTH_STATUS_UUID))
                    .then(characteristic => characteristic.readValue());
            }

            async startBatteryNotifications(listener) {
                return this.device.gatt.getPrimaryService(Cphw.CPHW_SERVICE_UUID)
                    .then(service => service.getCharacteristic(Cphw.CPHW_BATTERY_UUID))
                    .then(characteristic => characteristic.startNotifications())
                    .then(characteristic => characteristic.addEventListener('characteristicvaluechanged', listener));
            }

            async disconnect() {
                if (!this.device) {
                    return Promise.reject('Device is not connected.');
                }
                return this.device.gatt.disconnect();
            }

            onDisconnected() {
                document.querySelector('#connectionStatus').innerText = 'Disconnected'
                console.log('Device is disconnected.');
                setRideModeButtonState(false);
            }

            onBatteryChanged(event) {
                console.log(buf2hex(event.target.value.buffer));
                var soc = event.target.value.getUint8(7);
                document.querySelector('#batteryLevel').innerText = soc;
            }

            async authenticate() {
                return this.readSerial()
                    .then(value => {
                        const decoder = new TextDecoder();
                        this.serial = decoder.decode(value.buffer.slice(0, 14))
                        console.log("serial: " + this.serial)
                        return fetch('./passcodes.csv');
                    })
                    .then(rsp => {
                        return rsp.text();
                    })
                    .then(lines => {
                        var passcode = 'FF'
                        for (let line of lines.split('\n')) {
                            if (line.split(',')[0] == this.serial) {
                                passcode = line.split(',')[1];
                                break
                            }
                        }
                        return this.writePasscode(hexToBytes(passcode))
                            .then(sleeper(500))
                            .then(_ => { return this.readAuthStatus(); })
                            .then(data => {
                                console.log("authentication state: " + data.getUint8(0));
                                if (data.getUint8(0) != 0xFF) {
                                    document.querySelector('#connectionStatus').innerText = 'Connected'
                                    setRideModeButtonState(true);
                                }
                            })
                    })
            }

            async connectAndAuth() {
                await this.request();
                await this.connect();
                console.log('connected');
                await this.authenticate();
                this.startBatteryNotifications(this.onBatteryChanged);
                // await this.disconnect();
            }

            setRideMode(mode) {
                console.log(mode)
            }

        }

        var cphw = new Cphw();
        var foo = [];

        function setRideModeButtonState(active) {
            if (active) {
                document.querySelector('#ecoButton').removeAttribute('disabled')
                document.querySelector('#stdButton').removeAttribute('disabled')
                document.querySelector('#turboButton').removeAttribute('disabled')
            } else {
                document.querySelector('#ecoButton').setAttribute('disabled', '')
                document.querySelector('#stdButton').setAttribute('disabled', '')
                document.querySelector('#turboButton').setAttribute('disabled', '')
            }
        }

        window.onload = function () {
            document.querySelector('#connectButton').addEventListener('click', () => cphw.connectAndAuth());
            document.querySelector('#ecoButton').addEventListener('click', () => cphw.setRideMode('eco'));
            document.querySelector('#stdButton').addEventListener('click', () => cphw.setRideMode('std'));
            document.querySelector('#turboButton').addEventListener('click', () => cphw.setRideMode('turbo'));
        };
    </script>
</head>

<body>
    <div class="container py-1">
        <h1>Status: <span id="connectionStatus">Disconnected</span></h1>
    </div>
    <div class="container py-2">
        <button id='connectButton' class="btn btn-primary">CONNECT</button>
    </div>
    <div class="container text-center">
        <div class="row align-items-start">
            <div class="d-grid col">
                <button class="btn btn-primary" id="ecoButton" disabled>
                    ECO
                </button>
            </div>
            <div class="d-grid col">
                <button class="btn btn-primary" id="stdButton" disabled>
                    STD
                </button>
            </div>
            <div class="d-grid col">
                <button class="btn btn-primary" id="turboButton" disabled>
                    TURBO
                </button>
            </div>
        </div>
    </div>
    <div class="container">
        <h3>Battery: <span id="batteryLevel">-</span></h3>
    </div>
</body>

</html>
